<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Flight Reports</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    body { 
      background: #f4f7fa; 
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; 
    }
    .navbar { 
      background: #0d6efd; 
    }
    .navbar-brand, .nav-link { 
      color: white !important; 
      font-weight: 500; 
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .navbar-brand:hover, .nav-link:hover { 
      color: #ffc107 !important; 
    }
    .container { 
      margin-top: 40px; 
    }
    h1 { 
      color: #333; 
      margin-bottom: 25px; 
      font-weight: bold; 
      text-align: center;
      text-transform: uppercase;
    }
    table { 
      background: #fff; 
      border-radius: 8px; 
      overflow: hidden; 
      box-shadow: 0 4px 10px rgba(0,0,0,0.08); 
    }
    th { 
      background: #0d6efd; 
      color: white; 
    }
    .delayed { 
      color: red !important; 
      font-weight: bold; 
    }
    .ontime { 
      color: green !important; 
      font-weight: bold; 
    }
    .btn-lg {
      font-size: 1.1rem;
      font-weight: 600;
      padding: 12px 25px;
      border-radius: 8px;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .apply-btn {
      background-color: #28a745;
      color: white;
      border: none;
      padding: 12px 25px;
      font-size: 1.1rem;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      margin-left: 15px;
    }
    .apply-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
    .btn-lg:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.2);
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="{{ url_for('index') }}" style="font-size: 2rem; font-weight: bold;">
      <i class="bi bi-airplane-engines"></i> Flight Manager
    </a>
    <div class="collapse navbar-collapse">
      <ul class="navbar-nav ms-auto">
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('index') }}">
            <i class="bi bi-calendar-check"></i> Schedule
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('reports') }}">
            <i class="bi bi-clipboard-data"></i> Reports
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="{{ url_for('logout') }}">
            <i class="bi bi-box-arrow-right"></i> Logout
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<div class="container">
  <h1><i class="bi bi-clipboard-data"></i> Flight Reports</h1>

  <!-- Delay Results Table -->
  <table class="table table-bordered text-center align-middle">
    <thead>
      <tr>
        <th><i class="bi bi-hash"></i> Flight ID</th>
        <th><i class="bi bi-clock-history"></i> Scheduled Time</th>
        <th><i class="bi bi-clock"></i> Arrival Time</th>
        <th><i class="bi bi-flag"></i> Status</th>
        <th><i class="bi bi-stopwatch"></i> Delay (min)</th>
      </tr>
    </thead>
    <tbody id="resultsBody">
      <!-- Filled by JS -->
    </tbody>
  </table>


  <!-- Generate Button -->
  <div class="text-center mt-4">
    <button class="btn btn-primary btn-lg" onclick="calculateDelays()">
      <i class="bi bi-bar-chart-line"></i> Generate Report
    </button>
    {% if role == 'admin' %}
     <button class="apply-btn"  id="applyDelaysBtn"><i class="bi-arrow-repeat"></i> Apply Delays to Database</button>
    {% endif %}
  </div>
</div>



<script>
function calculateDelays() {
  fetch("/calculate_delay", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({})
  })
  .then(response => response.json())
  .then(data => {
    let resultsBody = document.getElementById("resultsBody");
    resultsBody.innerHTML = "";

    data.forEach(f => {
      let delayMinutes = 0;
      if (f.delayed) {
        const [origH, origM] = f.original_arrival.split(":").map(Number);
        const [adjH, adjM] = f.adjusted_arrival.split(":").map(Number);
        delayMinutes = (adjH * 60 + adjM) - (origH * 60 + origM);
      }

      let row = `
        <tr>
          <td>${f.flight_id}</td>
          <td>${f.original_arrival}</td>
          <td>${f.adjusted_arrival}</td>
          <td class="${f.delayed ? 'delayed' : 'ontime'}">
            ${f.delayed ? 'Delayed' : 'On Time'}
          </td>
          <td>${f.delayed ? delayMinutes : '-'}</td>
        </tr>
      `;
      resultsBody.innerHTML += row;
    });
  });
}
document.getElementById('applyDelaysBtn').addEventListener('click', async () => {
    if(!confirm("Are you sure you want to apply these delays to the database?")) return;

    const response = await fetch('/apply_delays', {
        method: 'POST'
    });
    const result = await response.json();
    alert(result.message);

    if(result.success){
        window.location.reload();  // refresh page to show applied changes
    }
});
</script>

</body>
</html>
